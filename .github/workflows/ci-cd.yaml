name: CI-CD AKS Terraform

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Login ACR
        uses: azure/docker-login@v1
        with:
          login-server: ${{ secrets.ACR_LOGIN_SERVER }}   # ex.: meuacr.azurecr.io
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Build & Push image
        env:
          IMAGE: ${{ secrets.ACR_LOGIN_SERVER }}/aks-terraform-app:latest
        run: |
          echo "Listando conteúdo do repositório:"
          ls -la
          echo "Validando pasta app e Dockerfile:"
          test -d app || { echo "ERRO: pasta ./app não encontrada"; exit 1; }
          test -f app/Dockerfile || { echo "ERRO: app/Dockerfile não encontrado"; exit 1; }

          # Build e push em um único comando (buildx)
          docker buildx build \
            --file app/Dockerfile \
            --tag "$IMAGE" \
            --push \
            app

      - name: AKS Context
        uses: azure/aks-set-context@v3
        with:
          resource-group: rg-aks-terraform-lab
          cluster-name: aks-terraform-lab

      # (Opcional) Garante que o AKS pode puxar do ACR via RBAC
      # Execute apenas uma vez fora do pipeline OU deixe aqui se rodar sempre:
      # - name: Attach ACR to AKS (RBAC-based pull)
      #   run: |
      #     az aks update -n aks-terraform-lab -g rg-aks-terraform-lab --attach-acr ${{ secrets.ACR_NAME }}

      - name: Render manifests e Deploy
        env:
          ACR_LOGIN_SERVER: ${{ secrets.ACR_LOGIN_SERVER }}
        run: |
          # Renderiza o host do ACR no deployment
          sed -i "s|ACR_LOGIN_SERVER|${ACR_LOGIN_SERVER}|g" k8s/deployment.yaml

          echo "Aplicando manifests:"
          kubectl apply -f k8s/

          echo "Mostrando status:"
          kubectl get deploy,po,svc -o wide